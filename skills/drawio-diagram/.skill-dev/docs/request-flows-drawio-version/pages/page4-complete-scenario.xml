<mxCell id="title" value="Page 4: 完整融合场景 - 复杂交互全景图" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontStyle=1;fontSize=16;fontColor=#333333;" vertex="1" parent="1">
  <mxGeometry x="400" y="10" width="400" height="30" as="geometry"/>
</mxCell>

<mxCell id="scenario_desc" value="场景: 用户创建复杂AWS架构图 → 部分截断 → 续传完成 → 修改部分内容 → 最终完成" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=11;fontColor=#666666;fontStyle=2;" vertex="1" parent="1">
  <mxGeometry x="250" y="40" width="700" height="20" as="geometry"/>
</mxCell>

<mxCell id="user_zone" value="User" style="swimlane;horizontal=0;startSize=30;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;" vertex="1" parent="1">
  <mxGeometry x="40" y="80" width="1120" height="100" as="geometry"/>
</mxCell>

<mxCell id="u1" value="1. 请求绘制&#xa;AWS架构图" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="user_zone">
  <mxGeometry x="50" y="30" width="100" height="50" as="geometry"/>
</mxCell>

<mxCell id="u2" value="2. 等待..." style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;dashed=1;" vertex="1" parent="user_zone">
  <mxGeometry x="320" y="35" width="70" height="40" as="geometry"/>
</mxCell>

<mxCell id="u3" value="3. 看到部分图表&#xa;(还在生成中)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;dashed=1;" vertex="1" parent="user_zone">
  <mxGeometry x="490" y="30" width="110" height="50" as="geometry"/>
</mxCell>

<mxCell id="u4" value="4. 看到完整图表" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="user_zone">
  <mxGeometry x="680" y="30" width="100" height="50" as="geometry"/>
</mxCell>

<mxCell id="u5" value="5. 请求修改&#xa;&quot;RDS改成Aurora&quot;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="user_zone">
  <mxGeometry x="820" y="30" width="110" height="50" as="geometry"/>
</mxCell>

<mxCell id="u6" value="6. 看到修改后图表" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1;" vertex="1" parent="user_zone">
  <mxGeometry x="990" y="25" width="110" height="55" as="geometry"/>
</mxCell>

<mxCell id="frontend_zone" value="Frontend" style="swimlane;horizontal=0;startSize=30;fillColor=#e1d5e7;strokeColor=#9673a6;fontStyle=1;" vertex="1" parent="1">
  <mxGeometry x="40" y="190" width="1120" height="180" as="geometry"/>
</mxCell>

<mxCell id="f1" value="ChatInput&#xa;接收请求" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="frontend_zone">
  <mxGeometry x="50" y="35" width="90" height="45" as="geometry"/>
</mxCell>

<mxCell id="f2" value="onFetchChart()&#xa;获取当前XML" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="frontend_zone">
  <mxGeometry x="50" y="95" width="90" height="45" as="geometry"/>
</mxCell>

<mxCell id="f3" value="sendMessage()&#xa;POST /api/chat" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="frontend_zone">
  <mxGeometry x="165" y="65" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="f4" value="useChat接收&#xa;display_diagram" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="frontend_zone">
  <mxGeometry x="380" y="35" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="f5" value="检测截断!&#xa;存partialXmlRef" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="frontend_zone">
  <mxGeometry x="380" y="95" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="f6" value="接收append&#xa;拼接XML" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="frontend_zone">
  <mxGeometry x="505" y="65" width="90" height="45" as="geometry"/>
</mxCell>

<mxCell id="f7" value="XML完整!&#xa;wrapWithMxFile" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="frontend_zone">
  <mxGeometry x="620" y="65" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="f8" value="validateAndFix&#xa;loadDiagram" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="frontend_zone">
  <mxGeometry x="620" y="125" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="f9" value="接收edit请求&#xa;(新一轮交互)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="frontend_zone">
  <mxGeometry x="805" y="35" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="f10" value="接收edit_diagram&#xa;replaceXMLParts" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="frontend_zone">
  <mxGeometry x="925" y="65" width="110" height="45" as="geometry"/>
</mxCell>

<mxCell id="f11" value="load修改后XML" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="frontend_zone">
  <mxGeometry x="990" y="125" width="100" height="40" as="geometry"/>
</mxCell>

<mxCell id="backend_zone" value="Backend" style="swimlane;horizontal=0;startSize=30;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1;" vertex="1" parent="1">
  <mxGeometry x="40" y="380" width="1120" height="100" as="geometry"/>
</mxCell>

<mxCell id="b1" value="route.ts&#xa;构建context" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="backend_zone">
  <mxGeometry x="165" y="30" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="b2" value="streamText()&#xa;调用LLM" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="backend_zone">
  <mxGeometry x="290" y="30" width="90" height="45" as="geometry"/>
</mxCell>

<mxCell id="b3" value="流式返回&#xa;tool calls" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="backend_zone">
  <mxGeometry x="420" y="30" width="90" height="45" as="geometry"/>
</mxCell>

<mxCell id="b4" value="接收edit请求&#xa;含currentXML" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="backend_zone">
  <mxGeometry x="805" y="30" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="llm_zone" value="LLM" style="swimlane;horizontal=0;startSize=30;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;" vertex="1" parent="1">
  <mxGeometry x="40" y="490" width="1120" height="120" as="geometry"/>
</mxCell>

<mxCell id="l1" value="理解意图&#xa;规划布局" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="llm_zone">
  <mxGeometry x="290" y="20" width="90" height="40" as="geometry"/>
</mxCell>

<mxCell id="l2" value="生成大型XML&#xa;display_diagram" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="llm_zone">
  <mxGeometry x="290" y="70" width="90" height="40" as="geometry"/>
</mxCell>

<mxCell id="l3" value="收到截断错误&#xa;调用append" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="llm_zone">
  <mxGeometry x="450" y="40" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="l4" value="续传完成" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="llm_zone">
  <mxGeometry x="580" y="45" width="80" height="35" as="geometry"/>
</mxCell>

<mxCell id="l5" value="分析edit请求&#xa;定位RDS元素" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="llm_zone">
  <mxGeometry x="860" y="20" width="100" height="40" as="geometry"/>
</mxCell>

<mxCell id="l6" value="生成edit_diagram&#xa;{search, replace}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="llm_zone">
  <mxGeometry x="860" y="70" width="100" height="40" as="geometry"/>
</mxCell>

<mxCell id="drawio_zone" value="DrawIO" style="swimlane;horizontal=0;startSize=30;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1;" vertex="1" parent="1">
  <mxGeometry x="40" y="620" width="1120" height="80" as="geometry"/>
</mxCell>

<mxCell id="d1" value="exportDiagram&#xa;返回当前XML" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="drawio_zone">
  <mxGeometry x="50" y="20" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="d2" value="postMessage&#xa;load完整XML" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="drawio_zone">
  <mxGeometry x="680" y="20" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="d3" value="postMessage&#xa;load编辑后XML" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="drawio_zone">
  <mxGeometry x="990" y="20" width="100" height="45" as="geometry"/>
</mxCell>

<mxCell id="eu1" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;strokeColor=#d6b656;" edge="1" parent="1" source="u1" target="f1">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ef1" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="f1" target="f2">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ef2" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="f2" target="d1">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ed1" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;dashed=1;strokeColor=#82b366;" edge="1" parent="1" source="d1" target="f3">
  <mxGeometry relative="1" as="geometry">
    <Array as="points">
      <mxPoint x="190" y="700"/>
      <mxPoint x="190" y="400"/>
      <mxPoint x="255" y="400"/>
    </Array>
  </mxGeometry>
</mxCell>

<mxCell id="ef3" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="f3" target="b1">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="eb1" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="b1" target="b2">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="eb2" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="b2" target="l1">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="el1" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="l1" target="l2">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="el2" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;dashed=1;strokeColor=#b85450;" edge="1" parent="1" source="l2" target="b3">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="eb3" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;dashed=1;strokeColor=#6c8ebf;" edge="1" parent="1" source="b3" target="f4">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ef4" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;strokeColor=#b85450;" edge="1" parent="1" source="f4" target="f5">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ef5" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;dashed=1;strokeColor=#b85450;" edge="1" parent="1" source="f5" target="l3">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="el3" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="l3" target="l4">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="el4" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;dashed=1;strokeColor=#82b366;" edge="1" parent="1" source="l4" target="f6">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ef6" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="f6" target="f7">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ef7" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="f7" target="f8">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ef8" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="f8" target="d2">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ed2" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;strokeColor=#00AA00;strokeWidth=2;" edge="1" parent="1" source="d2" target="u4">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="eu5" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;strokeColor=#d6b656;" edge="1" parent="1" source="u5" target="f9">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ef9" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="f9" target="b4">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="eb4" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="b4" target="l5">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="el5" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="l5" target="l6">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="el6" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;dashed=1;strokeColor=#b85450;" edge="1" parent="1" source="l6" target="f10">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ef10" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="f10" target="f11">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ef11" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;" edge="1" parent="1" source="f11" target="d3">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="ed3" style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;strokeColor=#00AA00;strokeWidth=2;" edge="1" parent="1" source="d3" target="u6">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="phase_box1" value="Phase 1: display_diagram" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#b85450;dashed=1;strokeWidth=2;verticalAlign=top;fontStyle=1;fontSize=10;" vertex="1" parent="1">
  <mxGeometry x="45" y="65" width="360" height="650" as="geometry"/>
</mxCell>

<mxCell id="phase_box2" value="Phase 2: append_diagram" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#82b366;dashed=1;strokeWidth=2;verticalAlign=top;fontStyle=1;fontSize=10;" vertex="1" parent="1">
  <mxGeometry x="415" y="65" width="290" height="650" as="geometry"/>
</mxCell>

<mxCell id="phase_box3" value="Phase 3: edit_diagram" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#6c8ebf;dashed=1;strokeWidth=2;verticalAlign=top;fontStyle=1;fontSize=10;" vertex="1" parent="1">
  <mxGeometry x="715" y="65" width="440" height="650" as="geometry"/>
</mxCell>

<mxCell id="legend" value="图例" style="swimlane;startSize=20;fillColor=#f5f5f5;strokeColor=#666666;fontStyle=1;fontSize=10;" vertex="1" parent="1">
  <mxGeometry x="40" y="720" width="500" height="80" as="geometry"/>
</mxCell>

<mxCell id="leg1" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="legend">
  <mxGeometry x="10" y="30" width="20" height="15" as="geometry"/>
</mxCell>
<mxCell id="leg1t" value="User" style="text;fontSize=9;align=left;" vertex="1" parent="legend">
  <mxGeometry x="35" y="28" width="40" height="20" as="geometry"/>
</mxCell>

<mxCell id="leg2" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="legend">
  <mxGeometry x="80" y="30" width="20" height="15" as="geometry"/>
</mxCell>
<mxCell id="leg2t" value="Frontend" style="text;fontSize=9;align=left;" vertex="1" parent="legend">
  <mxGeometry x="105" y="28" width="50" height="20" as="geometry"/>
</mxCell>

<mxCell id="leg3" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="legend">
  <mxGeometry x="160" y="30" width="20" height="15" as="geometry"/>
</mxCell>
<mxCell id="leg3t" value="Backend" style="text;fontSize=9;align=left;" vertex="1" parent="legend">
  <mxGeometry x="185" y="28" width="50" height="20" as="geometry"/>
</mxCell>

<mxCell id="leg4" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="legend">
  <mxGeometry x="240" y="30" width="20" height="15" as="geometry"/>
</mxCell>
<mxCell id="leg4t" value="LLM" style="text;fontSize=9;align=left;" vertex="1" parent="legend">
  <mxGeometry x="265" y="28" width="30" height="20" as="geometry"/>
</mxCell>

<mxCell id="leg5" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="legend">
  <mxGeometry x="300" y="30" width="20" height="15" as="geometry"/>
</mxCell>
<mxCell id="leg5t" value="DrawIO" style="text;fontSize=9;align=left;" vertex="1" parent="legend">
  <mxGeometry x="325" y="28" width="45" height="20" as="geometry"/>
</mxCell>

<mxCell id="leg6" value="" style="endArrow=classic;dashed=1;strokeColor=#666666;" edge="1" parent="legend">
  <mxGeometry relative="1" as="geometry">
    <mxPoint x="10" y="60" as="sourcePoint"/>
    <mxPoint x="50" y="60" as="targetPoint"/>
  </mxGeometry>
</mxCell>
<mxCell id="leg6t" value="Stream/Async" style="text;fontSize=9;align=left;" vertex="1" parent="legend">
  <mxGeometry x="55" y="52" width="70" height="20" as="geometry"/>
</mxCell>

<mxCell id="leg7" value="" style="endArrow=classic;strokeColor=#00AA00;strokeWidth=2;" edge="1" parent="legend">
  <mxGeometry relative="1" as="geometry">
    <mxPoint x="140" y="60" as="sourcePoint"/>
    <mxPoint x="180" y="60" as="targetPoint"/>
  </mxGeometry>
</mxCell>
<mxCell id="leg7t" value="Complete" style="text;fontSize=9;align=left;" vertex="1" parent="legend">
  <mxGeometry x="185" y="52" width="55" height="20" as="geometry"/>
</mxCell>

<mxCell id="summary" value="关键流程总结:&#xa;&#xa;• display_diagram: 创建新图表,若截断则触发append&#xa;• append_diagram: 拼接续传XML片段直到完整&#xa;• edit_diagram: 基于search/replace增量修改现有图表&#xa;&#xa;三种工具协同工作,覆盖所有图表操作场景" style="shape=note;whiteSpace=wrap;html=1;size=14;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;align=left;" vertex="1" parent="1">
  <mxGeometry x="560" y="720" width="320" height="100" as="geometry"/>
</mxCell>

<mxCell id="tools_ref" value="CLI 工具对照:&#xa;&#xa;• validate-xml.ts → 验证&#xa;• wrap-xml.ts → 包装&#xa;• edit-xml.ts → 编辑&#xa;• append-xml.ts → 续传&#xa;• check-complete.ts → 截断检测" style="shape=note;whiteSpace=wrap;html=1;size=14;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;align=left;" vertex="1" parent="1">
  <mxGeometry x="900" y="720" width="180" height="100" as="geometry"/>
</mxCell>
